name: Build Example App

on:
  push:
    branches: [main]
    paths:
      - "DesignSystemExamples/**"
      - "Sources/**"
      - "Package.swift"
  workflow_dispatch:

jobs:
  build-example:
    name: Build Example App
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Resolve Package Dependencies
        run: |
          if [ -f "DesignSystemExamples/DesignSystemExamples.xcodeproj/project.pbxproj" ]; then
            xcodebuild -resolvePackageDependencies \
              -project DesignSystemExamples/DesignSystemExamples.xcodeproj
          fi

      - name: Build Example App
        run: |
          if [ -f "DesignSystemExamples/DesignSystemExamples.xcodeproj/project.pbxproj" ]; then
            # Resolve package dependencies first
            xcodebuild -resolvePackageDependencies \
              -project DesignSystemExamples/DesignSystemExamples.xcodeproj
            
            # Build the example app
            xcodebuild clean build \
              -project DesignSystemExamples/DesignSystemExamples.xcodeproj \
              -scheme DesignSystemExamples \
              -destination "platform=iOS Simulator,name=iPhone 15,OS=latest" \
              -skipPackagePluginValidation \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          else
            echo "Example app not found, skipping build"
            exit 1
          fi

      - name: Archive Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.destination }}
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/Build/Products/**/*.app
          retention-days: 7
