name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest
    
    strategy:
      matrix:
        destination:
          - platform: iOS Simulator,name: iPhone 15,OS:latest
          - platform: iOS Simulator,name: iPhone 15 Pro,OS:latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
      
      - name: Show Xcode Version
        run: xcodebuild -version
      
      - name: Show Swift Version
        run: swift --version
      
      - name: Cache Swift Package Manager
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Build Package
        run: swift build
      
      - name: Test Package
        run: swift test
      
      - name: Build with Xcode
        run: |
          xcodebuild clean build \
            -scheme MobileDesignSystem \
            -destination "${{ matrix.destination }}" \
            -skipPackagePluginValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Build Example App (if exists)
        continue-on-error: true
        run: |
          if [ -f "DesignSystemExamples/DesignSystemExamples.xcodeproj/project.pbxproj" ]; then
            # Resolve package dependencies first
            xcodebuild -resolvePackageDependencies \
              -project DesignSystemExamples/DesignSystemExamples.xcodeproj
            
            # Build the example app
            xcodebuild clean build \
              -project DesignSystemExamples/DesignSystemExamples.xcodeproj \
              -scheme DesignSystemExamples \
              -destination "${{ matrix.destination }}" \
              -skipPackagePluginValidation \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          else
            echo "Example app not found, skipping..."
          fi

  lint:
    name: Lint
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
      
      - name: Run SwiftLint (if available)
        continue-on-error: true
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint
          else
            echo "SwiftLint not installed, skipping..."
          fi
